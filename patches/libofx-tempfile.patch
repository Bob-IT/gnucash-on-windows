diff --git a/lib/ofx_preproc.cpp b/lib/ofx_preproc.cpp
index 68a4170..c5fc7ee 100644
--- a/lib/ofx_preproc.cpp
+++ b/lib/ofx_preproc.cpp
@@ -34,13 +34,13 @@
 #include <iconv.h>
 #endif
 
-#ifdef OS_WIN32
+#ifdef __WIN32__
 # define DIRSEP "\\"
 #else
 # define DIRSEP "/"
 #endif
 
-#ifdef OS_WIN32
+#ifdef __WIN32__
 # include "win32.hh"
 # include <windows.h> // for GetModuleFileName()
 # undef ERROR
@@ -111,7 +111,11 @@ int ofx_proc_file(LibofxContextPtr ctx, const char * p_filename)
     mkTempFileName("libofxtmpXXXXXX", tmp_filename, sizeof(tmp_filename));
 
     message_out(DEBUG, "ofx_proc_file(): Creating temp file: " + string(tmp_filename));
+#ifdef __WIN32__
+    tmp_file_fd = mkstemp_win32(tmp_filename);
+#else
     tmp_file_fd = mkstemp(tmp_filename);
+#endif
     if (tmp_file_fd)
     {
       tmp_file.open(tmp_filename);
@@ -310,7 +314,7 @@ int ofx_proc_file(LibofxContextPtr ctx, const char * p_filename)
             size_t outbytesleft = inbytesleft * 2 - 1;
             iconv_buffer = (char*) malloc (inbytesleft * 2);
             memset(iconv_buffer, 0, inbytesleft * 2);
-#if defined(OS_WIN32) || defined(__sun)
+#if defined(__sun)
             const char * inchar = (const char *)s_buffer.c_str();
 #else
             char * inchar = (char *)s_buffer.c_str();
@@ -528,7 +532,7 @@ string sanitize_proprietary_tags(string input_string)
 }
 
 
-#ifdef OS_WIN32
+#ifdef __WIN32__
 static std::string get_dtd_installation_directory()
 {
   // Partial implementation of
@@ -583,7 +587,7 @@ std::string find_dtd(LibofxContextPtr ctx, const std::string& dtd_filename)
     }
   }
 
-#ifdef OS_WIN32
+#ifdef __WIN32__
   dtd_path_filename = get_dtd_installation_directory();
   if (!dtd_path_filename.empty())
   {
diff --git a/lib/ofx_utilities.cpp b/lib/ofx_utilities.cpp
index 602c866..8ef4668 100644
--- a/lib/ofx_utilities.cpp
+++ b/lib/ofx_utilities.cpp
@@ -28,7 +28,7 @@
 #include "messages.hh"
 #include "ofx_utilities.hh"
 
-#ifdef OS_WIN32
+#ifdef __WIN32__
 # define DIRSEP "\\"
 #else
 # define DIRSEP "/"
@@ -273,7 +273,7 @@ std::string get_tmp_dir()
   if (var) return var;
   var = getenv("TEMP");
   if (var) return var;
-#ifdef OS_WIN32
+#ifdef __WIN32__
   return "C:\\";
 #else
   return "/tmp";
diff --git a/lib/win32.cpp b/lib/win32.cpp
index 69078f2..5f863de 100644
--- a/lib/win32.cpp
+++ b/lib/win32.cpp
@@ -25,9 +25,9 @@
 
 
 
-#ifdef OS_WIN32
+#ifdef __WIN32__
 
-int mkstemp(char *tmpl)
+int mkstemp_win32(char *tmpl)
 {
   int fd = -1;
   int len;
diff --git a/lib/win32.hh b/lib/win32.hh
index 353093a..8df3970 100644
--- a/lib/win32.hh
+++ b/lib/win32.hh
@@ -21,9 +21,9 @@
 #endif
 
 
-#ifdef OS_WIN32
+#ifdef __WIN32__
 
-int mkstemp(char *tmpl);
+int mkstemp_win32(char *tmpl);
 
 
 #endif
